{% set page_title = "Class" %}
{% extends "layout.html" %}

{% block title %}
  Class List
{% endblock %}

{% block main %}
<!-- Page Header -->
<div class="flex flex-col gap-4 mb-8">

  <!-- Top Action Buttons -->
  <div class="flex justify-between items-center">
    <div class="flex items-center gap-3">

      <!-- Add Class -->
      <a href="{{ url_for('admin.class_add') }}" 
        class="flex items-center gap-2 rounded-full border border-[var(--clr-border)] 
               bg-[var(--clr-glass-light)] backdrop-blur-md px-5 py-2 
               text-[var(--clr-txt-primary)] font-medium shadow-sm hover:shadow-md 
               hover:border-[var(--clr-glow-primary)] hover:bg-[var(--clr-glass-border)] 
               transition-all">
        <span class="material-symbols-rounded text-[var(--clr-txt-hover)]">add_circle</span>
        Add Class
      </a>

    </div>
  </div>

  <!-- Search and Filters -->
  <form method="get" action="{{ url_for('admin.class_list') }}" 
        class="w-full flex flex-col gap-3 bg-[var(--clr-glass-light)] backdrop-blur-md 
               border border-[var(--clr-border)] rounded-3xl px-5 py-4 shadow-sm 
               hover:shadow-md transition-all duration-300">

    <!-- Search -->
    <div class="flex items-center w-full bg-[var(--clr-glass-light)] rounded-full px-4 py-2 shadow-sm 
                hover:shadow-md transition-all duration-300 focus-within:ring-2 focus-within:ring-[var(--clr-primary)]">
      <span class="material-symbols-rounded text-[var(--clr-txt-secondary)] mr-2">search</span>
      <input 
        type="text" 
        name="search" 
        value="{{ search or '' }}" 
        placeholder="Search class, subject, or teacher..."
        class="bg-transparent w-full focus:outline-none text-[var(--clr-txt-primary)] placeholder-[var(--clr-txt-secondary)]"
      >
      {% if search %}
      <a href="{{ url_for('admin.class_list') }}" 
         class="material-symbols-rounded text-[var(--clr-txt-secondary)] ml-2 hover:text-[var(--clr-error)] transition-colors duration-200">
        close
      </a>
      {% endif %}
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-3">

      <!-- Status Filter -->
      <select name="status" 
        class="px-3 py-2 rounded-full border border-[var(--clr-border)] bg-[var(--clr-glass-light)] 
               text-[var(--clr-txt-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <option class="bg-[var(--clr-bg)]" value="all" {% if selected_status == 'all' %}selected{% endif %}>All Status</option>
        <option class="bg-[var(--clr-bg)]" value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
        <option class="bg-[var(--clr-bg)]" value="cancelled" {% if selected_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        <option class="bg-[var(--clr-bg)]" value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Completed</option>
      </select>

      <!-- Subject Filter -->
      <select name="subject" 
        class="px-3 py-2 rounded-full border border-[var(--clr-border)] bg-[var(--clr-glass-light)] 
               text-[var(--clr-txt-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <option class="bg-[var(--clr-bg)]" value="">All Subjects</option>
        {% for s in subjects %}
          <option class="bg-[var(--clr-bg)]" value="{{ s.id }}" {% if s.id|string == subject_id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>

      <!-- Section Filter -->
      <select name="section" 
        class="px-3 py-2 rounded-full border border-[var(--clr-border)] bg-[var(--clr-glass-light)] 
               text-[var(--clr-txt-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <option class="bg-[var(--clr-bg)]" value="">All Sections</option>
        {% for sec in sections %}
          <option class="bg-[var(--clr-bg)]" value="{{ sec.id }}" {% if sec.id|string == section_id %}selected{% endif %}>{{ sec.name }}</option>
        {% endfor %}
      </select>

      <!-- Teacher Filter -->
      <select name="teacher" 
        class="px-3 py-2 rounded-full border border-[var(--clr-border)] bg-[var(--clr-glass-light)] 
               text-[var(--clr-txt-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <option class="bg-[var(--clr-bg)]" value="">All Teachers</option>
        {% for t in teachers %}
          <option class="bg-[var(--clr-bg)]" value="{{ t.id }}" {% if t.id|string == teacher_id %}selected{% endif %}>{{ t.full_name }}</option>
        {% endfor %}
      </select>

      <!-- Submit Button -->
      <button type="submit" 
        class="px-5 py-2.5 rounded-full bg-[var(--clr-primary)] text-white font-medium shadow-md 
               hover:bg-[var(--clr-glow-primary)] transition-all">
        Filter
      </button>
    </div>
  </form>
</div>


<!-- Title -->
<h1 class="text-2xl font-semibold mb-6 text-[var(--clr-txt-primary)]">Class List</h1>

<!-- Table -->
<div class="overflow-x-auto rounded-3xl border border-[var(--clr-glass-border)] bg-[var(--clr-glass-light)] backdrop-blur-md shadow-xl">
  <table class="w-full border-collapse text-sm">
    <thead class="bg-[var(--clr-surface-alt)]/70 text-[var(--clr-txt-secondary)]">
      <tr>
        <th class="px-4 py-3 text-left">Teacher</th>
        <th class="px-4 py-3 text-left">Subject</th>
        <th class="px-4 py-3 text-left">Section</th>
        <th class="px-4 py-3 text-left">Status</th>
        <th class="px-4 py-3 text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for c in classes %}
      <tr class="border-t border-[var(--clr-border)] hover:bg-[var(--clr-glass-border)]/40 transition-all">
        <td class="px-4 py-3 whitespace-nowrap">{{ c.teacher_first_name }} {{ c.teacher_last_name }}</td>
        <td class="px-4 py-3 whitespace-nowrap">{{ c.subject_name }}</td>
        <td class="px-4 py-3 whitespace-nowrap">{{ c.section_name }} ({{ c.academic_year }})</td>
        <td class="px-4 py-3 whitespace-nowrap">
          <form method="POST" action="{{ url_for('admin.class_status_update', id=c.class_id) }}">
            <select name="status" onchange="this.form.submit()" 
                    class="px-2 py-1 rounded-full border border-[var(--clr-border)] bg-[var(--clr-bg)] text-[var(--clr-txt-primary)] focus:ring-2 focus:ring-[var(--clr-primary)]">
              <option value="active" {% if c.status == 'active' %}selected{% endif %}>Active</option>
              <option value="cancelled" {% if c.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
              <option value="completed" {% if c.status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
          </form>
        </td>

        <td class="px-4 py-3 text-center">
          <div class="flex justify-center gap-2">
            <!-- Edit -->
            <a href="{{ url_for('admin.class_edit', id=c.class_id) }}"
               class="flex items-center justify-center gap-1 rounded-full bg-[var(--clr-glass-light)] border border-[var(--clr-border)] px-3 py-1.5 text-[var(--clr-txt-hover)] hover:bg-[var(--clr-glow-tertiary)]/10 hover:shadow-md transition-all">
              <span class="material-symbols-rounded text-base">edit</span>
              Edit
            </a>

            <!-- Delete -->
            {% if c.status == 'completed' or c.status == 'cancelled' %}
            <form action="{{ url_for('admin.delete') }}" 
                  method="POST" 
                  class="inline"
                  onsubmit="return openConfirmFormModal(event, this, 'Delete Class', 'This will permanently delete the class. Continue?')">
              <input type="hidden" name="id" value="{{ c.class_id }}">
              <input type="hidden" name="table" value="Class">
              <button type="submit" 
                      class="flex items-center justify-center gap-1 rounded-full bg-[var(--clr-glass-light)] border border-[var(--clr-border)] px-3 py-1.5 text-[var(--clr-error)] hover:bg-[var(--clr-error)]/10 hover:shadow-md transition-all">
                <span class="material-symbols-rounded text-base">delete</span> 
                
              </button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center py-6 text-[var(--clr-txt-secondary)]">
          No classes found.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
