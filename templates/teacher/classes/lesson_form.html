{% extends "layout.html" %}
{% block title %}Manage Lessons{% endblock %}

{% block main %}

<div class="w-full h-full">
    <div class="flex items-center justify-start gap-3 mb-8">
        <!-- Go Back Button -->
        <a href="{{ url_for('teacher.view_class', class_id=class_id) }}"
        class="ml-2 flex items-center justify-center w-9 h-9 rounded-full 
                bg-[color:var(--clr-surface-secondary)] 
                text-[color:var(--clr-txt-secondary)] 
                hover:bg-[color:var(--clr-primary)] 
                border-[var(clr-border)]
                border-2
                hover:text-white 
                shadow-sm 
                transition-all duration-200 ease-in-out">
            <span class="material-symbols-outlined text-lg">arrow_back</span>
        </a>

        <!-- Page Title -->
        <h2 class="text-3xl font-semibold text-[color:var(--clr-primary)] ml-2">
            Manage Lessons
        </h2>
    </div>


  <!-- Main Flex Layout -->
  <div class="flex flex-col md:flex-row gap-8 items-start">
    
    <!-- Add Lesson Form (Left) -->
<div class="w-full md:w-1/3 bg-[color:var(--clr-surface)] border border-[color:var(--clr-border)]
            rounded-2xl shadow-md p-6
            md:sticky md:top-6 self-start md:h-fit">
  <h3 class="text-xl font-semibold mb-4 text-[color:var(--clr-txt-primary)]">Add New Lesson</h3>
  <form action="{{ url_for('teacher.manage_lesson', class_id=class_id) }}"
        method="POST"
        enctype="multipart/form-data"
        class="space-y-5">

    <div>
      <label class="block font-medium mb-1 text-[color:var(--clr-txt-secondary)]">Lesson Title</label>
      <input type="text" name="title"
             class="w-full rounded-lg border border-[color:var(--clr-border)] bg-[color:var(--clr-bg)]
                    px-4 py-2 text-[color:var(--clr-txt-primary)]
                    focus:ring-2 focus:ring-[color:var(--clr-primary)] outline-none"
             placeholder="Enter lesson title" required>
    </div>

    <div>
      <label class="block font-medium mb-1 text-[color:var(--clr-txt-secondary)]">Description</label>
      <textarea name="description"
                class="w-full rounded-lg border border-[color:var(--clr-border)] bg-[color:var(--clr-bg)]
                       px-4 py-2 text-[color:var(--clr-txt-primary)]
                       focus:ring-2 focus:ring-[color:var(--clr-primary)] outline-none"
                placeholder="Enter lesson description (optional)" rows="3"></textarea>
    </div>

    <div>
      <label class="block font-medium mb-1 text-[color:var(--clr-txt-secondary)]">Attach File (optional)</label>
      <input type="file" name="file"
             class="w-full rounded-lg border border-[color:var(--clr-border)] bg-[color:var(--clr-bg)]
                    px-4 py-2 focus:ring-2 focus:ring-[color:var(--clr-primary)] outline-none">
    </div>

    <button type="submit"
            class="w-full py-2 rounded-lg bg-[color:var(--clr-primary)] text-white font-medium
                   hover:bg-[color:var(--clr-secondary)] transition">
      Add Lesson
    </button>
  </form>
</div>


    <!-- Lesson List (Right) -->
    <div class="w-full md:w-2/3 bg-[color:var(--clr-surface)] border border-[color:var(--clr-border)] rounded-2xl shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-[color:var(--clr-txt-primary)]">Existing Lessons</h3>

        {% if lessons %}
        <form id="orderForm" method="POST" action="{{ url_for('teacher.update_lesson_order', class_id=class_id) }}">
          <input type="hidden" name="order" id="orderInput" value="">
          <button type="submit"
                  class="px-4 py-2 rounded-lg bg-[color:var(--clr-success)] text-white text-sm font-medium hover:opacity-90 transition">
            Update Order
          </button>
        </form>
        {% endif %}
      </div>

      {% if lessons %}
      <ul id="lessonList" class="space-y-3">
        {% for lesson in lessons %}
        <li class="flex items-center justify-between p-4 rounded-xl border border-[color:var(--clr-border)] bg-[color:var(--clr-bg)] shadow-sm hover:shadow-md transition"
            data-lesson-id="{{ lesson.id }}">
          <!-- Grippy box -->
          <div class="cursor-grab flex items-center justify-center text-[color:var(--clr-txt-muted)] mr-3" title="Drag to reorder">
            <span class="material-symbols-outlined select-none">drag_indicator</span>
          </div>

          <!-- Lesson Info -->
          <div class="flex-1">
            <p class="font-semibold text-[color:var(--clr-txt-primary)]">{{ lesson.lesson_number }}. {{ lesson.title }}</p>
            <p class="text-sm text-[color:var(--clr-txt-muted)]">{{ lesson.description or 'â€”' }}</p>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 ml-3">
            <a href="{{ url_for('teacher.edit_lesson', class_id=class_id, lesson_id=lesson.id) }}"
               class="flex items-center justify-center w-8 h-8 rounded-full bg-[var(--clr-warning)]/80 text-white hover:bg-[var(--clr-warning)] transition-all duration-200 shadow-sm"
               title="Edit">
              <span class="material-symbols-outlined text-base align-middle">edit</span>
            </a>
            <button type="button"
                    data-delete-url="{{ url_for('teacher.delete_lesson', class_id=class_id, lesson_id=lesson.id) }}"
                    onclick="confirmAndDelete(this)"
                    class="flex items-center justify-center w-8 h-8 rounded-full bg-[var(--clr-error)]/80 text-white hover:bg-[var(--clr-error)] transition-all duration-200 shadow-sm"
                    title="Delete">
              <span class="material-symbols-outlined text-base align-middle">delete</span>
            </button>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-[color:var(--clr-txt-muted)]">No lessons added yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const lessonList = document.getElementById("lessonList");
  const orderInput = document.getElementById("orderInput");
  const orderForm = document.getElementById("orderForm");

  function serializeOrder() {
    const order = [];
    lessonList?.querySelectorAll("li").forEach((item, index) => {
      order.push({ id: item.getAttribute("data-lesson-id"), new_order: index + 1 });
    });
    return JSON.stringify(order);
  }

  if (lessonList) {
    new Sortable(lessonList, {
      animation: 150,
      handle: ".cursor-grab", // grippy handle
      onEnd() { orderInput.value = serializeOrder(); }
    });
    orderInput.value = serializeOrder();
  }

  orderForm?.addEventListener("submit", function() {
    orderInput.value = serializeOrder();
  });
});

// Reusable confirm modal logic
function openConfirmModal(title, message, action, method = "post", onConfirm = null) {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    confirmForm.action = action;
    confirmForm.method = method;

    // Store the callback for the confirm button
    confirmForm.onsubmit = (e) => {
        e.preventDefault(); // prevent default form submit if using JS action
        confirmModal.classList.add("hidden");
        if (onConfirm) onConfirm();
    };

    confirmModal.classList.remove("hidden");
}

// Close modal when pressing cancel or outside the content
confirmCancel.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
});
confirmModal.addEventListener("click", (e) => {
    if (e.target === confirmModal) {
        confirmModal.classList.add("hidden");
    }
});

// --- Main delete handler using modal ---
function confirmAndDelete(btn) {
    const url = btn.getAttribute("data-delete-url");
    if (!url) return;

    // Open your custom modal instead of browser confirm()
    openConfirmModal(
        "Confirm Delete",
        "Are you sure you want to delete this lesson?",
        "#", // no actual form submit
        "post",
        () => {
            // Perform the fetch only when user confirms
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "" // adjust if backend requires CSRF or data
            })
            .then(response => {
                if (response.redirected) {
                    window.location = response.url;
                } else {
                    window.location.reload();
                }
            })
            .catch(err => {
                console.error("Delete failed", err);
                alert("Could not delete lesson. See console for details.");
            });
        }
    );
}
</script>
{% endblock %}
