{% extends "layout.html" %}
{% block title %}Manage Lessons{% endblock %}

{% block main %}
<div class="container mt-4">
    <h2 class="mb-4">Manage Lessons</h2>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Add lesson form -->
    <form action="{{ url_for('teacher.manage_lesson', class_id=class_id) }}" method="POST" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <label class="form-label">Lesson Title</label>
            <input type="text" name="title" class="form-control" placeholder="Enter lesson title" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" placeholder="Enter lesson description (optional)" rows="3"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Attach File (optional)</label>
            <input type="file" name="file" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary">Add Lesson</button>
    </form>

    <!-- Lesson List -->
    <h4>Existing Lessons</h4>
    {% if lessons %}
    <!-- Single form to update order (no nested forms inside) -->
    <form id="orderForm" method="POST" action="{{ url_for('teacher.update_lesson_order', class_id=class_id) }}">
        <ul id="lessonList" class="list-group mb-3">
            {% for lesson in lessons %}
            <li class="list-group-item d-flex justify-content-between align-items-center"
                data-lesson-id="{{ lesson.id }}">
                <div>
                    <strong>{{ lesson.lesson_number }}. {{ lesson.title }}</strong><br>
                    <small class="text-muted">{{ lesson.description or '—' }}</small>
                </div>
                <div class="d-flex gap-1 align-items-center">
                    <a href="{{ url_for('teacher.edit_lesson', class_id=class_id, lesson_id=lesson.id) }}"
                       class="btn btn-sm btn-warning me-1">Edit</a>

                    <!-- Delete button uses JS fetch (no nested form) -->
                    <button type="button" class="btn btn-sm btn-danger"
                            data-delete-url="{{ url_for('teacher.delete_lesson', class_id=class_id, lesson_id=lesson.id) }}"
                            onclick="confirmAndDelete(this)">
                        Delete
                    </button>
                </div>
            </li>
            {% endfor %}
        </ul>

        <input type="hidden" name="order" id="orderInput" value="">
        <button type="submit" class="btn btn-success">Update Order</button>
    </form>
    {% else %}
    <p class="text-muted">No lessons added yet.</p>
    {% endif %}
</div>

<!-- SortableJS (for drag and drop) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const lessonList = document.getElementById("lessonList");
    const orderInput = document.getElementById("orderInput");
    const orderForm = document.getElementById("orderForm");

    function serializeOrder() {
        const order = [];
        lessonList.querySelectorAll("li").forEach((item, index) => {
            order.push({
                id: item.getAttribute("data-lesson-id"),
                new_order: index + 1
            });
        });
        return JSON.stringify(order);
    }

    // initialize Sortable
    if (lessonList) {
        new Sortable(lessonList, {
            animation: 150,
            onEnd: function() {
                // update hidden input automatically when user finishes dragging
                orderInput.value = serializeOrder();
            }
        });

        // set initial value on load (so Update Order works right away)
        orderInput.value = serializeOrder();
    }

    // ensure order is set right before form submit (coverage if user didn't drag)
    if (orderForm) {
        orderForm.addEventListener("submit", function() {
            orderInput.value = serializeOrder();
        });
    }
});

// Delete via fetch to avoid nested forms. Uses POST to the delete URL.
function confirmAndDelete(btn) {
    const url = btn.getAttribute("data-delete-url");
    if (!url) return;

    if (!confirm("Are you sure you want to delete this lesson?")) {
        return;
    }

    // create a small POST request (no CSRF included — add token if your app requires it)
    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "" // no body required; route only needs POST
    }).then(response => {
        if (response.redirected) {
            // If your endpoint redirects (typical flash+redirect), follow it:
            window.location = response.url;
            return;
        }
        // otherwise reload to reflect changes
        window.location.reload();
    }).catch(err => {
        console.error("Delete failed", err);
        alert("Could not delete lesson. See console for details.");
    });
}
</script>
{% endblock %}
