{% set page_title = "Activity Submissions" %}
{% extends "layout.html" %}

{% block title %}Activity Submissions{% endblock %}

{% block main %}

<div class="h-full w-full">
    <div class="flex flex-row items-center text-center mb-5">
        <a href="{{ url_for('teacher.activity_list', class_id=activity.class_id) }}"
                 class="mr-2 ml-2 flex items-center justify-center w-7 h-7 sm:w-12 sm:h-12 rounded-full border border-[var(--clr-txt-secondary)] hover:border-[var(--clr-primary)] hover:text-[var(--clr-primary)] text-[var(--clr-txt-secondary)] transition">
                  <span class="material-symbols-outlined text-xl sm:text-2xl">arrow_back</span>
        </a>
        <h1 class="text-2xl font-bold ml-4 mb-4">{{ activity.title }}</h1>
    </div>

    <div class="bg-[var(--clr-glass-light)] p-4 rounded-xl shadow-sm border border-[var(--clr-border)]">
        <h2 class="text-xl font-semibold">Submissions</h2>

        <p class="text-sm text-gray-600 mt-2 mb-4">
            Total Students: {{ submissions|length }} |
            Submitted: {{ submissions|selectattr("submitted_at")|list|length }} |
            Not Submitted: {{ submissions|rejectattr("submitted_at")|list|length }}
        </p>

       <!-- DESKTOP CARDS -->
<div class="hidden md:grid md:grid-cols-1 gap-4">
    {% for s in submissions %}
    <div class="bg-[var(--clr-surface)] border border-[var(--clr-border)] rounded-2xl shadow-sm p-4 hover:shadow-md transition flex flex-col gap-3">
        
        <!-- Header: Student + Status -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <p class="font-semibold text-lg text-[var(--clr-txt-primary)]">{{ s.first_name }} {{ s.last_name }}</p>
            <div class="flex items-center gap-3 text-sm sm:text-base">
                <span class="text-[var(--clr-txt-muted)]">
                    {% if s.submitted_at %}Submitted: {{ s.submitted_at }}{% else %}Not Submitted{% endif %}
                </span>
                <span class="{% if not s.submitted_at %}text-[var(--clr-txt-muted)] font-semibold{% elif s.is_late %}text-[var(--clr-error)] font-semibold{% else %}text-[var(--clr-success)] font-semibold{% endif %}">
                    {% if not s.submitted_at %}Pending{% elif s.is_late %}Late{% else %}On Time{% endif %}
                </span>
            </div>
        </div>

        <!-- File & Text Answer -->
        <div class="flex flex-col sm:flex-row sm:items-start gap-4">
            <!-- File -->
            <div class="flex flex-col gap-2 w-full sm:w-1/3">
                <p class="font-semibold text-[var(--clr-txt-secondary)]">File</p>
                {% if s.file_name %}
                <div class="flex flex-wrap gap-2">
                    <button onclick="openPreviewInNewTab('{{ s.file_name }}', {{ activity.id }})"
                            class="px-3 py-1 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-xs sm:text-sm shadow-sm">
                        Quick View
                    </button>
                    <a href="/uploads/activities/{{ activity.id }}/{{ s.file_name }}" download
                       class="px-3 py-1 bg-[var(--clr-surface-alt)] text-[var(--clr-txt-primary)] rounded-lg text-xs hover:bg-[var(--clr-surface)] transition">
                        Download
                    </a>
                </div>
                {% else %}
                    <span class="text-[var(--clr-txt-muted)] text-sm">No File</span>
                {% endif %}
            </div>

            <!-- Text Answer -->
            <div class="flex flex-col gap-1 w-full sm:w-2/3">
                <p class="font-semibold text-[var(--clr-txt-secondary)]">Text Answer</p>
                {% if s.text_answer %}
<div class="relative flex flex-col gap-1">
    <div class="max-h-16 overflow-hidden text-[var(--clr-txt-primary)] p-2 border border-[var(--clr-border)] rounded-lg transition-all duration-300"
         id="text-answer-{{ s.id }}">
        {{ s.text_answer }}
    </div>
    <button onclick="toggleTextExpand('text-answer-{{ s.id }}')" 
            class="self-end text-[var(--clr-info)] text-xs hover:underline">
        Expand/Collapse
    </button>
</div>
                {% else %}
                    <span class="text-[var(--clr-txt-muted)] text-sm">No Answer</span>
                {% endif %}
            </div>
        </div>

        <!-- Grading -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 mt-2">
            {% if s.submitted_at %}
            <form method="POST" action="{{ url_for('teacher.grade_submission', submission_id=s.id) }}"
                  class="flex flex-col sm:flex-row sm:items-center gap-2 w-full">
                <input type="number" name="score" min="0" max="{{ activity.max_score }}"
                       value="{{ s.score or '' }}"
                       placeholder="Score"
                       class="px-3 py-2 border rounded-lg w-full sm:w-28 text-sm sm:text-base">
                <input type="text" name="feedback" value="{{ s.feedback or '' }}"
                       placeholder="Feedback"
                       class="px-3 py-2 border rounded-lg flex-1 text-sm sm:text-base" 
                       title="{{ s.feedback }}">
                <button type="submit"
                        class="px-4 py-2 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-sm sm:text-base">
                    Save
                </button>
            </form>
            {% else %}
                <span class="text-[var(--clr-txt-muted)] italic">No Submission</span>
            {% endif %}
        </div>

    </div>
    {% endfor %}
</div>

  <!-- MOBILE CARDS -->
<div class="md:hidden space-y-4">
  {% for s in submissions %}
  <div class="p-4 rounded-2xl border border-[var(--clr-border)] bg-[var(--clr-surface)]
              dark:bg-[var(--clr-surface-alt)] shadow-sm hover:shadow-md transition flex flex-col gap-3">

    <!-- Header: Name + Status -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1">
      <p class="font-semibold text-[var(--clr-txt-primary)] text-base">{{ s.first_name }} {{ s.last_name }}</p>
      <div class="flex items-center justify-between gap-2 text-xs sm:text-sm text-[var(--clr-txt-muted)]">
        <span>{% if s.submitted_at %}Submitted: {{ s.submitted_at }}{% else %}Not Submitted{% endif %}</span>
        <span class="{% if not s.submitted_at %}text-[var(--clr-txt-muted)] font-semibold{% elif s.is_late %}text-[var(--clr-error)] font-semibold{% else %}text-[var(--clr-success)] font-semibold{% endif %}">
          {% if not s.submitted_at %}Pending{% elif s.is_late %}Late{% else %}On Time{% endif %}
        </span>
      </div>
    </div>

    <!-- File -->
    <div class="flex flex-wrap gap-2">
      <p class="font-semibold text-[var(--clr-txt-secondary)] w-full">File</p>
      {% if s.file_name %}
        <button 
            onclick="window.open('/uploads/activities/{{ activity.id }}/{{ s.file_name }}', '_blank')"
            class="px-3 py-1 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-xs sm:text-sm shadow-sm">
            View
        </button>
        <a href="/uploads/activities/{{ activity.id }}/{{ s.file_name }}" download
           class="px-3 py-1 bg-[var(--clr-surface-alt)] text-[var(--clr-txt-primary)] rounded-lg text-xs sm:text-sm hover:bg-[var(--clr-surface)] transition">
            Download
        </a>
      {% else %}
        <span class="text-[var(--clr-txt-muted)] text-sm">No File</span>
      {% endif %}
    </div>

    <!-- Text Answer -->
    <div class="flex flex-col gap-1">
      <p class="font-semibold text-[var(--clr-txt-secondary)]">Text Answer</p>
      {% if s.text_answer %}
<div class="relative flex flex-col gap-1">
  <div class="max-h-16 overflow-hidden p-2 border border-[var(--clr-border)] rounded-lg text-[var(--clr-txt-primary)] transition-all duration-300"
       id="mobile-text-answer-{{ s.id }}">
    {{ s.text_answer }}
  </div>
  <button onclick="toggleTextExpand('mobile-text-answer-{{ s.id }}')"
          class="self-end text-[var(--clr-info)] text-xs hover:underline">
    Expand/Collapse
  </button>
</div>
      {% else %}
        <span class="text-[var(--clr-txt-muted)] text-sm">No Answer</span>
      {% endif %}
    </div>

    <!-- Grading -->
    <div>
      {% if s.submitted_at %}
      <form method="POST" action="{{ url_for('teacher.grade_submission', submission_id=s.id) }}" 
            class="flex flex-col gap-2 sm:flex-row sm:items-center">
        <input type="number" name="score" min="0" max="{{ activity.max_score }}"
               value="{{ s.score or '' }}"
               placeholder="Score"
               class="px-3 py-2 border rounded-lg w-full sm:w-28 text-sm sm:text-base">
        <input type="text" name="feedback" value="{{ s.feedback or '' }}"
               placeholder="Feedback"
               class="px-3 py-2 border rounded-lg w-full sm:flex-1 text-sm sm:text-base" 
               title="{{ s.feedback }}">
        <button type="submit"
                class="px-4 py-2 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-sm sm:text-base">
          Save
        </button>
      </form>
      {% else %}
        <span class="text-[var(--clr-txt-muted)] italic">No Submission</span>
      {% endif %}
    </div>

  </div>
  {% endfor %}
</div>
    </div>
</div>

<!-- ðŸ” Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-3xl w-full p-4 relative">
        <button onclick="closePreviewModal()" 
                class="absolute top-2 right-2 text-gray-500 hover:text-black text-xl">&times;</button>
        <div id="previewContent" class="mt-6">
            <!-- Dynamic preview content -->
        </div>
    </div>
</div>

<script>
function openPreviewInNewTab(filename, activityId) {
    const ext = filename.split('.').pop().toLowerCase();
    const src = `/uploads/activities/${activityId}/quick/${filename}`;

    // For all file types, just open in a new tab
    window.open(src, '_blank');
}
function toggleTextExpand(id) {
    const el = document.getElementById(id);
    const collapsedHeight = 64; // px, matches max-h-16 (~16*4=64px)

    // If currently expanded
    if (el.dataset.expanded === "true") {
        el.style.maxHeight = collapsedHeight + "px";
        el.classList.add('overflow-hidden');
        el.dataset.expanded = "false";
    } else {
        el.style.maxHeight = el.scrollHeight + "px";
        el.classList.remove('overflow-hidden');
        el.dataset.expanded = "true";
    }
}

</script>

{% endblock %}
