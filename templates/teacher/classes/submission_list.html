{% set page_title = "Activity Submissions" %}
{% extends "layout.html" %}

{% block title %}Activity Submissions{% endblock %}

{% block main %}

<div class="h-full w-full">
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">

    <!-- Left: Back Button + Activity Title -->
    <div class="flex items-center gap-3">
        <a href="{{ url_for('teacher.activity_list', class_id=activity.class_id) }}"
           class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-full 
                  bg-[var(--clr-surface)] text-[var(--clr-txt-secondary)]
                  shadow-sm hover:text-[var(--clr-primary)] hover:shadow transition">
            <span class="material-symbols-outlined text-xl sm:text-2xl">arrow_back</span>
        </a>
        <h1 class="text-2xl sm:text-3xl font-bold text-[var(--clr-txt-primary)]">
            {{ activity.title }}
        </h1>
    </div>

    <!-- Right: Stats -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 text-[var(--clr-txt-secondary)] text-sm sm:text-base">
        <h2 class="font-semibold text-lg sm:text-xl">Submissions:</h2>
        <p class="text-sm sm:text-base">
            Total Students: <strong>{{ submissions|length }}</strong> |
            Submitted: <strong>{{ submissions|selectattr("submitted_at")|list|length }}</strong> |
            Not Submitted: <strong>{{ submissions|rejectattr("submitted_at")|list|length }}</strong>
        </p>
    </div>

</div>


 <div class="mt-10 space-y-4">

   <!-- DESKTOP CARDS -->
<div class="hidden md:grid md:grid-cols-1 gap-4">
    {% for s in submissions %}
    <div class="bg-[var(--clr-surface)] border border-[var(--clr-border)] rounded-2xl shadow-sm transition">

        <!-- Header: Student Name + Score + Expand Icon -->
        <button 
            {% if s.submitted_at %}
                type="button" onclick="toggleCard('card-body-{{ s.id }}')"
            {% else %}
                type="button" disabled
            {% endif %}
            class="w-full flex justify-between items-center px-4 py-3 rounded-2xl
                   bg-[var(--clr-surface-alt)] dark:bg-[var(--clr-surface)] focus:outline-none
                   hover:bg-[var(--clr-surface)] transition {{ 'cursor-not-allowed opacity-70' if not s.submitted_at else '' }}">
            <div class="flex flex-col items-start">
                <p class="font-semibold text-lg text-[var(--clr-txt-primary)]">{{ s.first_name }} {{ s.last_name }}</p>
                {% if s.submitted_at %}
                    <span class="text-sm text-[var(--clr-success)]">Score: {{ s.score or 'N/A' }}
                    </span>
                    <span class="text-sm {% if s.due_date %} text-[var(--clr-error)] {% else %}text-[var(--clr-success)]{% endif %}">| {% if s.due_date %}Late{% else %} On time{% endif %}</span>
                {% else %}
                    <span class="text-sm text-[var(--clr-txt-muted)]">Not Submitted</span>
                {% endif %}
            </div>
            {% if s.submitted_at %}
                <span class="material-symbols-rounded text-[var(--clr-info)]" id="icon-{{ s.id }}">expand_more</span>
            {% endif %}
        </button>

        {% if s.submitted_at %}
        <!-- Collapsible Body (only for submitted) -->
        <div class="overflow-hidden max-h-0 transition-all duration-300" id="card-body-{{ s.id }}">
            <div class="px-4 py-3 border-t border-[var(--clr-border)] rounded-b-2xl">

                <!-- File & Text Answer -->
                <div class="flex flex-col sm:flex-row sm:items-start gap-4 mb-2">
                    <!-- File -->
                    <div class="flex flex-col gap-2 w-full sm:w-1/3">
                        <p class="font-semibold text-[var(--clr-txt-secondary)]">File</p>
                        {% if s.file_name %}
                        <div class="flex flex-wrap gap-2">
                            <button onclick="openPreviewInNewTab('{{ s.file_name }}', {{ activity.id }})"
                                    class="px-3 py-1 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-xs sm:text-sm shadow-sm">
                                Quick View
                            </button>
                            <a href="/uploads/activities/{{ activity.id }}/{{ s.file_name }}" download
                               class="px-3 py-1 bg-[var(--clr-surface-alt)] text-[var(--clr-txt-primary)] rounded-lg text-xs hover:bg-[var(--clr-surface)] transition">
                                Download
                            </a>
                        </div>
                        {% else %}
                            <span class="text-[var(--clr-txt-muted)] text-sm">No File</span>
                        {% endif %}
                    </div>

                    <!-- Text Answer -->
                    <div class="flex flex-col gap-1 w-full sm:w-2/3">
                        <p class="font-semibold text-[var(--clr-txt-secondary)]">Text Answer</p>
                        {% if s.text_answer %}
                        <div class="p-2 border border-[var(--clr-border)] rounded-lg text-[var(--clr-txt-primary)]">
                            {{ s.text_answer }}
                        </div>
                        {% else %}
                            <span class="text-[var(--clr-txt-muted)] text-sm">No Answer</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Grading Section -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 mt-2">
                    <form method="POST" action="{{ url_for('teacher.grade_submission', submission_id=s.id) }}"
                        class="flex flex-col sm:flex-row sm:items-center gap-2 w-full">
                        <input type="number" name="score" min="0" max="{{ activity.max_score }}"
                            value="{{ s.score or '' }}"
                            placeholder="Score"
                            class="px-3 py-2 border rounded-lg w-full sm:w-28 text-sm sm:text-base">
                        <input type="text" name="feedback" value="{{ s.feedback or '' }}"
                            placeholder="Feedback"
                            class="px-3 py-2 border rounded-lg flex-1 text-sm sm:text-base" 
                            title="{{ s.feedback }}">
                        <button type="submit"
                                class="px-4 py-2 bg-[var(--clr-primary)] text-white rounded-lg hover:bg-[var(--clr-secondary)] transition text-sm sm:text-base">
                            Save
                        </button>
                    </form>
                </div>

            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

</div>

<script>
function toggleCard(id) {
    const cardBody = document.getElementById(id);
    const icon = document.getElementById("icon-" + id.split('-').pop());
    const content = cardBody.firstElementChild;

    if (cardBody.style.maxHeight && cardBody.style.maxHeight !== "0px") {
        cardBody.style.maxHeight = "0px";
        icon.textContent = "expand_more";
    } else {
        cardBody.style.maxHeight = content.scrollHeight + "px";
        icon.textContent = "expand_less";
    }
}

function openPreviewInNewTab(filename, activityId) {
    const src = `/uploads/activities/${activityId}/quick/${filename}`;
    window.open(src, '_blank');
}
</script>


{% endblock %}
