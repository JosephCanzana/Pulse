{% extends "layout.html" %}
{% block title %}Profile{% endblock %}

{% block main %}
<section class="h-full w-full space-y-10">

  <!-- Header -->
  <div class="flex items-center gap-4">
    <div class="w-20 h-20 flex items-center justify-center rounded-full bg-[var(--clr-primary)] text-white text-3xl font-bold">
      {{ user.first_name[0] }}{{ user.last_name[0] }}
    </div>
    <h1 class="text-3xl font-extrabold text-[var(--clr-primary)]">My Profile</h1>
  </div>

  <form method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-10">

    <!-- LEFT SIDE -->
    <div class="space-y-6">
      <div>
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">First Name</label>
        <input type="text" name="first_name" value="{{ user.first_name }}" 
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]"
               {% if role != 'admin' %}readonly{% endif %}>
      </div>

      <div>
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">Middle Name</label>
        <input type="text" name="middle_name" value="{{ user.middle_name }}" 
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]"
               {% if role != 'admin' %}readonly{% endif %}>
      </div>

      <div>
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">Last Name</label>
        <input type="text" name="last_name" value="{{ user.last_name }}" 
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]"
               {% if role != 'admin' %}readonly{% endif %}>
      </div>

      <div>
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">Email</label>
        <input type="email" name="email" value="{{ user.email }}" 
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]"
               {% if role != 'admin' %}readonly{% endif %}>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="space-y-6">

      {% if role == 'admin' %}
      <!-- Current Password -->
      <div class="relative">
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">Current Password</label>
        <input type="password" name="current_password" id="current_password"
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <button type="button" onclick="togglePassword('current_password')" 
                class="absolute right-3 top-9 text-[var(--clr-txt-muted)] text-sm">Show</button>
      </div>

      <!-- New Password -->
      <div class="relative">
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">New Password</label>
        <input type="password" name="new_password" id="new_password" 
               oninput="checkPasswordStrength(this)" 
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <button type="button" onclick="togglePassword('new_password')" 
                class="absolute right-3 top-9 text-[var(--clr-txt-muted)] text-sm">Show</button>
        <p id="password_strength" class="mt-1 text-sm text-[var(--clr-txt-muted)]">Must be 8+ characters, include uppercase, number, and special character.</p>
      </div>

      <!-- Confirm New Password -->
      <div class="relative">
        <label class="block text-sm font-semibold text-[var(--clr-txt-secondary)] mb-1">Confirm New Password</label>
        <input type="password" name="confirm_password" id="confirm_password"
               class="w-full px-4 py-2 border border-[var(--clr-border)] rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--clr-primary)]">
        <button type="button" onclick="togglePassword('confirm_password')" 
                class="absolute right-3 top-9 text-[var(--clr-txt-muted)] text-sm">Show</button>
      </div>
      {% endif %}

      {% if extra_profile %}
      <div class="space-y-2">
        <h2 class="text-[var(--clr-txt-primary)] font-semibold text-lg">Additional Info</h2>
        {% if role == 'student' %}
          <p><strong>Education Level:</strong> {{ extra_profile.education_level_name or '-' }}</p>
          <p><strong>Course:</strong> {{ extra_profile.course_name or '-' }}</p>
          <p><strong>Section:</strong> {{ extra_profile.section_name or '-' }}</p>
        {% elif role == 'teacher' %}
          <p><strong>Education Level:</strong> {{ extra_profile.education_level_name or '-' }}</p>
          <p><strong>Department:</strong> {{ extra_profile.department_name or '-' }}</p>
        {% endif %}
      </div>
      {% endif %}

      {% if role in ['teacher', 'student'] %}
      <div class="p-4 bg-[var(--clr-surface-alt)] rounded-lg text-[var(--clr-txt-muted)]">
        <p class="font-semibold">Notice:</p>
        <p>To change your information, please contact the admin.</p>
      </div>
      {% endif %}

      {% if role == 'admin' %}
      <button type="submit" class="px-6 py-2 bg-[var(--clr-primary)] text-white font-semibold rounded-lg hover:bg-[var(--clr-secondary)] transition">
        Update Profile
      </button>
      {% endif %}
    </div>

  </form>
</section>

<script>
  function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
  }

  function checkPasswordStrength(input) {
    const strengthText = document.getElementById('password_strength');
    const val = input.value.trim();

    if (val.length === 0) {
      strengthText.textContent = "Must be 8+ characters, include uppercase, number, and special character.";
      strengthText.className = "mt-1 text-sm text-gray-500";
      return;
    }

    const weak = /.{1,7}$/;
    const medium = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
    const strong = /^(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

    if (strong.test(val)) {
      strengthText.textContent = "Strong password";
      strengthText.className = "mt-1 text-sm font-semibold text-green-600";
    } else if (medium.test(val)) {
      strengthText.textContent = "Medium strength — add a special character for extra security.";
      strengthText.className = "mt-1 text-sm font-semibold text-yellow-600";
    } else if (weak.test(val)) {
      strengthText.textContent = "Weak password — add uppercase, number, and special character.";
      strengthText.className = "mt-1 text-sm font-semibold text-red-600";
    } else {
      strengthText.textContent = "Must be 8+ characters, include uppercase, number, and special character.";
      strengthText.className = "mt-1 text-sm text-gray-500";
    }
  }
</script>

{% endblock %}
