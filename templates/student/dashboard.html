{% set page_title = "Student Dashboard" %}
{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block main %}
<section class="w-full h-full space-y-10">

  <!-- HEADER -->
  <header class="mb-6">
    <h1 class="text-3xl font-bold text-[var(--clr-primary)] leading-tight">
      Welcome back, {{ name }}!
    </h1>
    <p class="text-[var(--clr-txt-muted)] mt-2 text-base">
      Let's continue your learning journey today.
    </p>
  </header>

  <!-- QUICK STATS + MOTIVATION -->
  <section class="grid grid-cols-1 lg:grid-cols-4 gap-6 relative">

    <!-- QUICK STATS -->
    <div class="lg:col-span-3">
      <h2 class="text-2xl font-semibold text-[var(--clr-txt-primary)] mb-4">
        Your Learning Summary
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% set stats = [
          ('Lessons Completed', total_lessons_completed or 0, 'check_circle'),
          ('Active Lessons', total_classes_active or 0, 'menu_book'),
          ('Lessons In Progress', lessons_in_progress or 0, 'hourglass_bottom')
        ] %}
        {% for title, value, icon in stats %}
        <div class="bg-[var(--clr-surface)] rounded-2xl border border-[var(--clr-border)] p-6 shadow-sm hover:shadow-md hover:scale-[1.01] transition">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-[var(--clr-txt-muted)]">{{ title }}</h3>
            <span class="material-symbols-outlined text-[var(--clr-primary)]">{{ icon }}</span>
          </div>
          <p class="text-3xl font-semibold text-[var(--clr-primary)] mt-2">{{ value }}</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- MOTIVATION / DAILY INSPIRATION -->
    {% if daily %}
    <div id="dailyPanel" class="bg-[var(--clr-surface)] rounded-2xl border border-[var(--clr-border)] shadow-sm px-6 py-5 hover:shadow-md transition-all duration-300 ease-out">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-[var(--clr-primary)] flex items-center gap-1">
          <span class="material-symbols-outlined text-[var(--clr-primary)] text-xl">lightbulb</span>
          Motivation
        </h2>
        <button id="hideDailyPanel" class="text-xs text-[var(--clr-secondary)] hover:underline">Hide</button>
      </div>

      <div class="flex text-xs font-medium border-b border-[var(--clr-border)] mb-3">
        <button type="button" class="tab-btn flex-1 py-1 text-center text-[var(--clr-txt-muted)] hover:text-[var(--clr-primary)]" data-tab="motivation">Motivation</button>
        <button type="button" class="tab-btn flex-1 py-1 text-center text-[var(--clr-txt-muted)] hover:text-[var(--clr-primary)]" data-tab="verse">Verse</button>
        <button type="button" class="tab-btn flex-1 py-1 text-center text-[var(--clr-txt-muted)] hover:text-[var(--clr-primary)]" data-tab="reflection">Reflection</button>
      </div>

      <div id="tab-motivation" class="tab-content text-sm leading-relaxed text-[var(--clr-txt-secondary)]">
        <p class="italic">"{{ daily.quote }}"</p>
        <p class="text-xs text-right text-[var(--clr-txt-muted)] mt-2">— {{ daily.author }}</p>
      </div>

      <div id="tab-verse" class="tab-content hidden text-sm leading-relaxed text-[var(--clr-txt-secondary)]">
        <p class="italic">"{{ daily.verse_text }}"</p>
        <p class="text-xs text-right text-[var(--clr-txt-muted)] mt-2">{{ daily.reference }}</p>
      </div>

      <div id="tab-reflection" class="tab-content hidden text-sm leading-relaxed text-[var(--clr-txt-secondary)]">
        <p class="italic">"{{ daily.message }}"</p>
        <p class="text-xs text-right text-[var(--clr-txt-muted)] mt-2">{{ daily.theme }}</p>
      </div>
    </div>

    <!-- Moved OUTSIDE the panel -->
    <button 
      id="showDailyPanel"
      class="hidden absolute top-0 right-0 text-sm text-[var(--clr-secondary)] hover:text-[var(--clr-txt-hover)] font-medium transition"
    >
      Show Motivation
    </button>
    {% endif %}
  </section>

  <!-- RECENT PROGRESS -->
  <section class="mt-12">
    <h2 class="text-2xl font-semibold text-[var(--clr-txt-primary)] mb-4 border-b border-[var(--clr-border)] pb-2">
      Recent Progress
    </h2>

    {% if recent_progress %}
    <ul class="divide-y divide-[var(--clr-border)] border border-[var(--clr-border)] rounded-xl bg-[var(--clr-surface)] shadow-sm">
      {% for p in recent_progress %}
      <li class="p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center hover:bg-[var(--clr-hover-surface)] transition">
        <div>
          <h3 class="font-medium text-[var(--clr-txt-primary)]">{{ p.lesson_title }}</h3>
          <p class="text-sm text-[var(--clr-txt-secondary)]">{{ p.subject_name }}</p>
        </div>
        <p class="text-xs text-[var(--clr-txt-muted)] mt-2 sm:mt-0">
          {% if p.status == 'in_progress' %}
            Started: {{ p.started_at | datetimeformat('%I:%M %p') }}
          {% elif p.status == 'completed' %}
            Completed: {{ p.completed_at | datetimeformat('%I:%M %p') }}
          {% endif %}
        </p>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div class="text-center text-[var(--clr-txt-muted)] py-10">
      No recent progress yet — start a lesson now!
    </div>
    {% endif %}
  </section>

</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
  const tabContents = Array.from(document.querySelectorAll(".tab-content"));
  const panel = document.getElementById("dailyPanel");
  const hideBtn = document.getElementById("hideDailyPanel");
  const showBtn = document.getElementById("showDailyPanel");

  // Restore hidden state
  const isHidden = sessionStorage.getItem("dailyPanelHidden") === "true";
  if (isHidden && panel) {
    panel.classList.add("hidden");
    showBtn?.classList.remove("hidden");
  }

  // Initial active tab
  if (tabButtons.length > 0) {
    const active = tabButtons[0];
    tabButtons.forEach(b => b.classList.remove("text-[var(--clr-primary)]", "border-b-2", "border-[var(--clr-primary)]"));
    tabContents.forEach(c => c.classList.add("hidden"));
    active.classList.add("text-[var(--clr-primary)]", "border-b-2", "border-[var(--clr-primary)]");
    document.getElementById(`tab-${active.dataset.tab}`)?.classList.remove("hidden");
  }

  // Tab switching
  tabButtons.forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      const target = btn.dataset.tab;
      tabButtons.forEach(b => b.classList.remove("text-[var(--clr-primary)]", "border-b-2", "border-[var(--clr-primary)]"));
      tabContents.forEach(c => c.classList.add("hidden"));
      btn.classList.add("text-[var(--clr-primary)]", "border-b-2", "border-[var(--clr-primary)]");
      document.getElementById(`tab-${target}`)?.classList.remove("hidden");
    });
  });

  // Hide/show animation
  hideBtn?.addEventListener("click", e => {
    e.preventDefault();
    panel?.classList.add("hidden");
    showBtn?.classList.remove("hidden");
    sessionStorage.setItem("dailyPanelHidden", "true");
  });
  
  showBtn?.addEventListener("click", e => {
    e.preventDefault();
    panel?.classList.remove("hidden");
    showBtn?.classList.add("hidden");
    sessionStorage.setItem("dailyPanelHidden", "false");
  });
});
</script>
{% endblock %}
