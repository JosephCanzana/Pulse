{% set page_title = "Manage Class" %}
{% extends "layout.html" %}
{% block title %}Class Details{% endblock %}

{% block main %}
<section class="min-h-full space-y-6">

  <!-- Top Row: Class Info + Lessons -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Class Info Card -->
    <div id="class-info-card" class="lg:col-span-1 bg-[var(--clr-surface)] dark:bg-[var(--clr-surface-alt)] rounded-2xl shadow-lg p-6 border border-[var(--clr-border-strong)] max-h-[310px] transition-all duration-300 flex flex-col justify-between">
      
      <!-- Static View -->
      <div id="view-mode">
        <h1 class="text-4xl pb-2 font-bold text-[var(--clr-primary)]">{{ class_info.subject_name }}</h1>
        <div class="text-[var(--clr-txt-secondary)] dark:text-[var(--clr-txt-muted)] mt-2 space-y-1 text-base">
          <p>Section: {{ class_info.section_name }}</p>
          <p>Course: {{ class_info.course_name or 'N/A' }}</p>
          <p>Level: {{ class_info.education_level or 'N/A' }}</p>
          <p>Status: {{ class_info.class_status }}</p>
        </div>
      </div>

      <div class="mt-6">
        <button id="edit-btn" type="button" 
          class="w-full text-center px-4 py-2 bg-[var(--clr-primary)] hover:bg-[var(--clr-secondary)] text-white font-medium rounded-lg shadow-md transition-all duration-200">
          Edit Class
        </button>
      </div>

      <!-- Edit Form -->
      <form id="edit-mode" method="POST" class="hidden mt-4 flex flex-col flex-1 justify-between">
        <div class="space-y-4">
          <div>
            <label class="block text-[var(--clr-txt-secondary)]" for="subject">Subject</label>
            <input list="subjects-list" name="subject_id" id="subject" class="mt-1 w-full p-2 border rounded-lg"
                  value="{{ class_info.subject_name }}">
            <datalist id="subjects-list">
              {% for sub in subjects %}
                <option value="{{ sub.name }}"></option>
              {% endfor %}
            </datalist>
          </div>

          <div>
            <label class="block text-[var(--clr-txt-secondary)]" for="section">Section</label>
            <input list="sections-list" name="section_id" id="section" class="mt-1 w-full p-2 border rounded-lg"
                  value="{{ class_info.section_name }}">
            <datalist id="sections-list">
              {% for sec in sections %}
                <option value="{{ sec.name }}"></option>
              {% endfor %}
            </datalist>
          </div>

          <div>
            <label class="block text-[var(--clr-txt-secondary)]" for="status">Status</label>
            <select name="class_status" id="status" class="mt-1 w-full p-2 border rounded-lg">
              <option class="bg-[var(--clr-bg)]" value="active" {% if class_info.class_status == 'active' %}selected{% endif %}>Active</option>
              <option class="bg-[var(--clr-bg)]" value="completed" {% if class_info.class_status == 'completed' %}selected{% endif %}>Completed</option>
              <option class="bg-[var(--clr-bg)]" value="cancelled" {% if class_info.class_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
          </div>

          <div>
            <label class="block text-[var(--clr-txt-secondary)]" for="class_color">Class Color</label>
            <div class="flex items-center gap-3 mt-1">
              <input 
                type="color" 
                id="class_color" 
                name="class_color" 
                class="h-10 w-16 border rounded-lg cursor-pointer" 
                value="{{ class_info.class_color or '#2196f3' }}">

              <!-- Reset button -->
              <button 
                type="button" 
                id="reset_color_btn"
                class="px-3 py-2 text-sm rounded-lg bg-[var(--clr-primary)] text-white hover:opacity-90 transition">
                Reset
              </button>
            </div>
          </div>

        </div>

        <div class="mt-6 flex gap-2">
          <button type="submit" class="flex-1 px-4 py-2 bg-[var(--clr-primary)] hover:bg-[var(--clr-secondary)] text-white font-medium rounded-lg shadow-md transition-all duration-200">
            Save
          </button>
          <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 bg-[var(--clr-border-strong)] hover:bg-[var(--clr-border)] text-[var(--clr-txt-primary)] font-medium rounded-lg shadow-md transition-all duration-200">
            Cancel
          </button>
        </div>
      </form>

    </div>

    <!-- Lessons Card -->
    <div class="lg:col-span-2 bg-[var(--clr-surface)] dark:bg-[var(--clr-surface-alt)] rounded-2xl max-h-[310px] shadow-lg p-6 border border-[var(--clr-border)] flex flex-col transition-all duration-300" id="lessons-card">
      
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">

      <h2 class="text-2xl font-semibold text-[var(--clr-txt-primary)] dark:text-[var(--clr-txt-primary)]">
        Lessons
      </h2>

      <div class="flex flex-col sm:flex-row gap-2">
        <a href="{{ url_for('teacher.activity_list', class_id=class_info.class_id ) }}"
          class="px-3 py-1 bg-[var(--clr-primary)] text-white rounded-lg shadow-md hover:bg-[var(--clr-secondary)] transition-all duration-200 text-sm text-center">
          View Submissions
        </a>

        <a href="{{ url_for('teacher.manage_lesson', class_id=class_info.class_id ) }}"
          class="px-3 py-1 bg-[var(--clr-primary)] text-white rounded-lg shadow-md hover:bg-[var(--clr-secondary)] transition-all duration-200 text-sm text-center">
          Manage Lessons
        </a>
      </div>

    </div>


      {% if no_lessons %}
        <p class="text-[var(--clr-txt-muted)] dark:text-[var(--clr-txt-secondary)]">No lessons created yet.</p>
      {% else %}
        <div class="overflow-y-auto flex-1 rounded-lg border border-[var(--clr-border)]" id="lessons-table-wrapper">
          <table class="min-w-full divide-y divide-[var(--clr-border)]">
            <thead class="bg-[var(--clr-surface-alt)] dark:bg-[var(--clr-surface)] sticky top-0 z-10">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Lesson #</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Title</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-[var(--clr-surface)] dark:bg-[var(--clr-surface-alt)] divide-y divide-[var(--clr-border)]">
              {% for lesson in lessons %}
              <tr class="hover:bg-[var(--clr-glass-light)] dark:hover:bg-[var(--clr-glass-dark)] transition-colors">
                <td class="px-4 py-3 text-sm">{{ lesson.lesson_number }}</td>
                <td class="px-4 py-3 text-sm">{{ lesson.title }}</td>
                <td class="px-4 py-3 text-sm">
                  <a href="{{ url_for('teacher.edit_lesson', class_id=class_info.class_id, lesson_id=lesson.id) }}"
                    class="text-[var(--clr-primary)] hover:text-[var(--clr-secondary)] font-medium transition-all duration-200">
                    Edit
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>

  </div>

  <!-- Bottom Row: Students -->
<div class="bg-[var(--clr-surface)] dark:bg-[var(--clr-surface-alt)] 
            rounded-2xl shadow-lg p-6 border border-[var(--clr-border)]">

  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold text-[var(--clr-txt-primary)] dark:text-[var(--clr-txt-primary)]">
      Enrolled Students
    </h2>
    <a href="{{ url_for('teacher.manage_student', class_id=class_info.class_id ) }}" 
       class="text-[var(--clr-primary)] hover:text-[var(--clr-secondary)] text-4xl flex items-center justify-center rounded-full w-10 h-10">
      <span class="material-symbols-outlined">tune</span>
    </a>
  </div>

  {% if no_students %}
    <p class="text-[var(--clr-txt-muted)] dark:text-[var(--clr-txt-secondary)]">
      No students enrolled yet.
    </p>

  {% else %}

   <!-- DESKTOP TABLE -->
<!-- DESKTOP TABLE -->
<div class="hidden md:block overflow-y-auto max-h-[300px] rounded-lg border border-[var(--clr-border)]">
  <table class="min-w-full divide-y divide-[var(--clr-border)]">
    <thead class="bg-[var(--clr-surface-alt)] dark:bg-[var(--clr-surface)] sticky top-0 z-10">
      <tr>
        <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Student Name</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Year</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Overall Grade</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Status</th>
        <th class="px-4 py-2 text-left text-sm font-medium text-[var(--clr-txt-secondary)]">Actions</th>
      </tr>
    </thead>

    <tbody class="bg-[var(--clr-surface)] dark:bg-[var(--clr-surface-alt)] divide-y divide-[var(--clr-border)]">
      {% for student in students %}
      <tr class="hover:bg-[var(--clr-glass-light)] dark:hover:bg-[var(--clr-glass-dark)] transition-colors">
        <td class="px-4 py-3 text-sm">{{ student.full_name }}</td>
        <td class="px-4 py-3 text-sm">{{ student.year }}</td>

        <!-- Overall Grade -->
        <td class="px-4 py-3 text-sm">
          {% if student.overall_percentage is not none %}
            {{ student.overall_percentage }}%
          {% else %}
            —
          {% endif %}
        </td>

        <!-- Status -->
        <td class="px-4 py-3 text-sm">
          <form method="POST" action="{{ url_for('teacher.update_student_status', class_id=class_info.class_id, cs_id=student.class_student_id) }}">
            <select name="status" onchange="this.form.submit()"
                    class="px-2 py-1 rounded-full border border-[var(--clr-border)] bg-[var(--clr-bg)] 
                           text-[var(--clr-txt-primary)] focus:ring-2 focus:ring-[var(--clr-primary)]">
              <option value="active" {% if student.enrollment_status == 'active' %}selected{% endif %}>Active</option>
              <option value="dropped" {% if student.enrollment_status == 'dropped' %}selected{% endif %}>Dropped</option>
              <option value="completed" {% if student.enrollment_status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
          </form>
        </td>

        <!-- Actions -->
        <td class="px-4 py-3 text-sm">
          <a href="{{ url_for('teacher.student_progress', class_id=class_info.class_id, school_id=student.school_id) }}"
            class="text-[var(--clr-primary)] hover:text-[var(--clr-secondary)] font-medium transition-all duration-200">
            Progress
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- MOBILE CARDS -->
<div class="md:hidden space-y-3">
  {% for student in students %}
  <div class="p-4 rounded-xl border border-[var(--clr-border)] bg-[var(--clr-surface)]
              dark:bg-[var(--clr-surface-alt)] shadow-sm">

    <!-- Name -->
    <p class="font-semibold text-[var(--clr-txt-primary)]">
      {{ student.full_name }}
    </p>

    <!-- Year & Overall Grade -->
    <div class="flex justify-between items-center mb-2 text-xs text-[var(--clr-txt-muted)]">
      <span>Year: {{ student.year }}</span>
      <span>
        Grade: 
        {% if student.overall_percentage is not none %}
          {{ student.overall_percentage }}%
        {% else %}
          —
        {% endif %}
      </span>
    </div>

    <!-- STATUS + ACTION ROW -->
    <div class="flex items-center gap-3">

      <!-- Status -->
      <form method="POST"
            action="{{ url_for('teacher.update_student_status', class_id=class_info.class_id, cs_id=student.class_student_id) }}"
            class="flex-1">
        <select name="status"
                onchange="this.form.submit()"
                class="w-full px-3 py-2 rounded-lg border border-[var(--clr-border)] bg-[var(--clr-bg)]
                      text-[var(--clr-txt-primary)] focus:ring-2 focus:ring-[var(--clr-primary)] text-sm">
          <option value="active" {% if student.enrollment_status == 'active' %}selected{% endif %}>Active</option>
          <option value="dropped" {% if student.enrollment_status == 'dropped' %}selected{% endif %}>Dropped</option>
          <option value="completed" {% if student.enrollment_status == 'completed' %}selected{% endif %}>Completed</option>
        </select>
      </form>

      <!-- Progress Button -->
      <a href="{{ url_for('teacher.student_progress', class_id=class_info.class_id, school_id=student.school_id) }}"
        class="px-4 py-2 text-sm rounded-lg bg-[var(--clr-primary)] text-white whitespace-nowrap hover:opacity-90 transition">
        Progress
      </a>

    </div>
  </div>
  {% endfor %}
</div>


      {% endif %}
    </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const colorInput = document.getElementById("class_color");
    const resetBtn = document.getElementById("reset_color_btn");

    resetBtn.addEventListener("click", () => {
      const defaultColor = "#2196f3";
      colorInput.value = defaultColor;
    });
  });
  const editBtn = document.getElementById('edit-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const viewMode = document.getElementById('view-mode');
  const editMode = document.getElementById('edit-mode');
  const classCard = document.getElementById('class-info-card');
  const lessonsCard = document.getElementById('lessons-card');

  editBtn.addEventListener('click', () => {
    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    // Expand card height when editing
    classCard.classList.add('max-h-[520px]');
    lessonsCard.classList.add('max-h-[520px]');
  });

  cancelBtn.addEventListener('click', () => {
    editMode.classList.add('hidden');
    viewMode.classList.remove('hidden');
    // Collapse card height when done editing
    classCard.classList.remove('max-h-[520px]');
    lessonsCard.classList.remove('max-h-[520px]');
  });
  
</script>
{% endblock %}
