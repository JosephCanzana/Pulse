{% set page_title = "Manage Lesson" %}
{% extends "layout.html" %}
{% block title %}Manage Lessons{% endblock %}

{% block main %}
<div class="w-full h-full">
    <!-- Header -->
    <div class="flex items-center justify-start gap-3 mb-6 sm:mb-8">
        <a href="{{ url_for('teacher.view_class', class_id=class_id) }}"
           class="flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-full 
                  bg-[var(--clr-surface)] text-[var(--clr-txt-secondary)]
                  shadow-sm hover:text-[var(--clr-primary)] hover:shadow transition">
            <span class="material-symbols-outlined text-xl sm:text-2xl">arrow_back</span>
        </a>

        <h2 class="text-2xl sm:text-3xl font-semibold text-[color:var(--clr-primary)] ml-1 sm:ml-2">
            Manage Lessons
        </h2>
    </div>

    <!-- Responsive Layout -->
    <div class="flex flex-col md:flex-row gap-4 sm:gap-6 md:gap-8 items-start">

        <!-- Add Lesson Form -->
        <div class="w-full md:w-1/3 bg-[var(--clr-surface)] border border-[var(--clr-border)]
                    rounded-2xl shadow-md p-4 sm:p-6 md:sticky md:top-18 md:h-fit">
            <h3 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-[var(--clr-txt-primary)]">
                Add New Lesson
            </h3>

            <form action="{{ url_for('teacher.manage_lesson', class_id=class_id) }}"
                  method="POST"
                  enctype="multipart/form-data"
                  class="space-y-4 sm:space-y-5">

                <!-- Title -->
                <div>
                    <label class="block font-medium mb-1 text-[var(--clr-txt-secondary)]">
                        Lesson Title
                    </label>
                    <input type="text" name="title"
                           class="w-full rounded-lg border border-[var(--clr-border)] bg-[var(--clr-bg)]
                                  px-3 py-2 sm:px-4 text-[var(--clr-txt-primary)]
                                  focus:ring-2 focus:ring-[var(--clr-primary)] outline-none"
                           placeholder="Enter lesson title" required>
                </div>

                <!-- Description -->
                <div>
                    <label class="block font-medium mb-1 text-[var(--clr-txt-secondary)]">
                        Description
                    </label>
                    <textarea name="description"
                              class="w-full rounded-lg border border-[var(--clr-border)] bg-[var(--clr-bg)]
                                     px-3 py-2 sm:px-4 text-[var(--clr-txt-primary)]
                                     focus:ring-2 focus:ring-[var(--clr-primary)] outline-none"
                              rows="3"
                              placeholder="Enter lesson description (optional)"></textarea>
                </div>

                <!-- File -->
                <div>
                    <label class="block font-medium mb-1 text-[var(--clr-txt-secondary)]">
                        Attach File (optional)
                    </label>
                    <input type="file" name="file"
                           class="w-full rounded-lg border border-[var(--clr-border)] bg-[var(--clr-bg)]
                                  px-3 py-2 focus:ring-2 focus:ring-[var(--clr-primary)] outline-none">
                </div>                

                <button type="submit"
                        class="w-full py-2 rounded-lg bg-[var(--clr-primary)] text-white font-medium
                               hover:bg-[var(--clr-secondary)] transition">
                    Add Lesson
                </button>
            </form>
        </div>

        <!-- Lesson List -->
<div class="w-full md:w-2/3 bg-[var(--clr-surface)] border border-[var(--clr-border)]
            rounded-2xl shadow-md p-4 sm:p-6">
  <div class="flex items-center justify-between mb-3 sm:mb-4">
    <h3 class="text-lg sm:text-xl font-semibold text-[var(--clr-txt-primary)]">
      Existing Lessons
    </h3>

    {% if lessons %}
    <form id="orderForm"
          method="POST"
          action="{{ url_for('teacher.update_lesson_order', class_id=class_id) }}"
          onsubmit="return openConfirmFormModal(event, this, 'Update Order', 'Are you sure you want to the lesson order?')">
      <input type="hidden" name="order" id="orderInput">
      <button type="submit"
              class="px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg bg-[var(--clr-success)] text-white 
                     text-xs sm:text-sm font-medium hover:opacity-90 transition">
        Update Lesson Order
      </button>
    </form>
    {% endif %}
  </div>

  {% if lessons %}
  <ul id="lessonList" class="space-y-2 sm:space-y-3">
    {% for lesson in lessons %}
    <li class="flex flex-col p-3 sm:p-4 rounded-xl border border-[var(--clr-border)] 
               bg-[var(--clr-bg)] shadow-sm hover:shadow-md transition"
        data-lesson-id="{{ lesson.id }}">

      <div class="flex items-center justify-between w-full">

        <!-- Drag Handle -->
        <div class="cursor-grab flex items-center justify-center 
                    text-[var(--clr-txt-muted)] mr-2 sm:mr-3 shrink-0"
             title="Drag to reorder">
          <span class="material-symbols-outlined text-base sm:text-lg select-none">
            drag_indicator
          </span>
        </div>

        <!-- Title -->
        <div class="flex-1 overflow-hidden">
          <p class="font-semibold text-[var(--clr-txt-primary)] 
                    text-sm sm:text-base truncate">
            {{ lesson.lesson_number }}. {{ lesson.title }}
          </p>

          <!-- Description (Desktop always visible) -->
          <p class="hidden md:block text-xs sm:text-sm text-[var(--clr-txt-muted)]">
            {{ lesson.description or 'â€”' }}
          </p>

          <!-- Mobile Toggle + Collapsible Description -->
          {% if lesson.description %}
          <button class="md:hidden text-[var(--clr-primary)] text-xs mt-1 underline"
                  onclick="toggleDesc(this)">
            Show Description
          </button>

          <p class="md:hidden text-xs text-[var(--clr-txt-muted)] mt-1 max-h-0 overflow-hidden 
                    transition-all duration-300">
            {{ lesson.description }}
          </p>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="flex gap-1 sm:gap-2 ml-2 sm:ml-3 shrink-0">

          <!-- Add Activity button -->
                  <a href="{{ url_for('teacher.activity_form', lesson_id=lesson.id) }}"
          class="relative flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full
                 bg-[var(--clr-primary)]/80 hover:bg-[var(--clr-primary)] text-white transition shadow-sm"
          title="{{ lesson.has_activity and 'Edit Activity' or 'Add Activity' }}">
          <span class="material-symbols-outlined text-xs sm:text-base">assignment</span>
          {% if lesson.has_activity %}
          <span class="absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full border border-[var(--clr-primary)]"></span>
          {% endif %}
        </a>


          <!-- Edit -->
          <a href="{{ url_for('teacher.edit_lesson', class_id=class_id, lesson_id=lesson.id) }}"
             class="flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full
                    bg-[var(--clr-warning)]/80 text-white hover:bg-[var(--clr-warning)] 
                    transition shadow-sm"
             title="Edit">
            <span class="material-symbols-outlined text-xs sm:text-base">edit</span>
          </a>

          <!-- Delete -->
          <form action="{{ url_for('teacher.delete_lesson', class_id=class_id, lesson_id=lesson.id) }}"
                method="POST"
                onsubmit="return openConfirmFormModal(event, this, 'Delete Lesson', 'This will permanently delete the lesson. Continue?')">
            <button type="submit"
                    class="flex items-center justify-center w-7 h-7 sm:w-8 sm:h-8 rounded-full
                           bg-[var(--clr-error)]/80 text-white hover:bg-[var(--clr-error)] 
                           transition shadow-sm"
                    title="Delete">
              <span class="material-symbols-outlined text-xs sm:text-base">delete</span>
            </button>
          </form>
        </div>
      </div>

    </li>
    {% endfor %}
  </ul>

  {% else %}
  <p class="text-[var(--clr-txt-muted)] text-sm sm:text-base">No lessons added yet.</p>
  {% endif %}
</div>
    </div>
</div>
<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
function toggleDesc(btn) {
    const desc = btn.nextElementSibling;
    const isOpen = desc.classList.contains("max-h-[200px]");

    if (!isOpen) {
        desc.classList.remove("max-h-0");
        desc.classList.add("max-h-[200px]");
        btn.textContent = "Hide Description";
    } else {
        desc.classList.remove("max-h-[200px]");
        desc.classList.add("max-h-0");
        btn.textContent = "Show Description";
    }
}
document.addEventListener("DOMContentLoaded", function() {
  const lessonList = document.getElementById("lessonList");
  const orderInput = document.getElementById("orderInput");
  const orderForm = document.getElementById("orderForm");

  function serializeOrder() {
    const order = [];
    lessonList?.querySelectorAll("li").forEach((item, index) => {
      order.push({ id: item.getAttribute("data-lesson-id"), new_order: index + 1 });
    });
    return JSON.stringify(order);
  }

  if (lessonList) {
    new Sortable(lessonList, {
      animation: 150,
      handle: ".cursor-grab", // grippy handle
      onEnd() { orderInput.value = serializeOrder(); }
    });
    orderInput.value = serializeOrder();
  }

  orderForm?.addEventListener("submit", function() {
    orderInput.value = serializeOrder();
  });
});

// Reusable confirm modal logic
function openConfirmModal(title, message, action, method = "post", onConfirm = null) {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    confirmForm.action = action;
    confirmForm.method = method;

    // Store the callback for the confirm button
    confirmForm.onsubmit = (e) => {
        e.preventDefault(); // prevent default form submit if using JS action
        confirmModal.classList.add("hidden");
        if (onConfirm) onConfirm();
    };

    confirmModal.classList.remove("hidden");
}

// Close modal when pressing cancel or outside the content
confirmCancel.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
});
confirmModal.addEventListener("click", (e) => {
    if (e.target === confirmModal) {
        confirmModal.classList.add("hidden");
    }
});

// --- Main delete handler using modal ---
function confirmAndDelete(btn) {
    const url = btn.getAttribute("data-delete-url");
    if (!url) return;

    // Open your custom modal instead of browser confirm()
    openConfirmModal(
        "Confirm Delete",
        "Are you sure you want to delete this lesson?",
        "#", // no actual form submit
        "post",
        () => {
            // Perform the fetch only when user confirms
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "" // adjust if backend requires CSRF or data
            })
            .then(response => {
                if (response.redirected) {
                    window.location = response.url;
                } else {
                    window.location.reload();
                }
            })
            .catch(err => {
                console.error("Delete failed", err);
                alert("Could not delete lesson. See console for details.");
            });
        }
    );
}
</script>
{% endblock %}
